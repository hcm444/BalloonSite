<!DOCTYPE html>
<html>
<head>
    <title>Plane Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/leaflet/1.0.0/leaflet.css" />
    <style>
        #map {
            height: 1000px;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://cdn.jsdelivr.net/leaflet/1.0.0/leaflet.js"></script>
    <script>
    function initMap() {
        var data = {{ data|tojson }};

        var map = L.map('map').setView([data[0][7], data[0][6]], 10);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
            maxZoom: 18,
        }).addTo(map);

        var coordinates = [];
        var timestamps = [];

        for (var i = 0; i < data.length; i++) {
            var latitude = data[i][7];
            var longitude = data[i][6];
            var timestamp = data[i][0];

            coordinates.push([latitude, longitude]);
            timestamps.push(timestamp);
        }

        var line = L.polyline(coordinates, { color: 'blue' }).addTo(map);

        var currentIndex = 0;
        var fadeInterval = setInterval(function() {
            var currentTimestamp = timestamps[currentIndex];
            var opacity = (Date.now() - currentTimestamp) / (timestamps[timestamps.length - 1] - currentTimestamp);
            line.setStyle({ opacity: opacity });

            currentIndex++;

            if (currentIndex >= coordinates.length) {
                clearInterval(fadeInterval);
            }
        }, 100);

        var latestData = data[data.length - 1];
        var popupContent = `
            <b>ICAO24:</b> ${latestData[1]}<br>
            <b>Callsign:</b> ${latestData[2]}<br>
            <b>Origin Country:</b> ${latestData[3]}<br>
            <b>Latitude:</b> ${latestData[7]}<br>
            <b>Longitude:</b> ${latestData[6]}<br>
            <b>Altitude:</b> ${latestData[8]}<br>
            <b>Heading:</b> ${latestData[10]}<br>
            <b>Timestamp:</b> ${latestData[0]}`;

        L.marker([latestData[7], latestData[6]])
            .bindPopup(popupContent)
            .addTo(map)
            .openPopup();
    }

    window.onload = initMap;
    </script>
</body>
</html>
